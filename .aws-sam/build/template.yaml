AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'payments-processor

  Demonstration of AWS SAM application

  '
Parameters:
  RecieptsBucketName:
    Type: String
    Default: payments-receipts
    Description: The name of S3 bucket where all the receipts are stored
  PaymentsQueueName:
    Type: String
    Default: paymentsQueue.fifo
    Description: Name of the payments queue
  CloudTrailBucketName:
    Type: String
    Default: payments-receipts-cloudtrail-event-bucket
    Description: Name of the cloud trail log buckets
Globals:
  Function:
    Timeout: 10
    Handler: app.lambdaHandler
    Runtime: nodejs12.x
Resources:
  ReceiptExtractorStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      Name: app-receipts-extractor
      DefinitionUri: ../../state-machines/receipts-extractor.asl.json
      Events:
        S3PutEvent:
          Type: EventBridgeRule
          Properties:
            Pattern:
              source:
              - aws.s3
              detail:
                requestParameters:
                  bucketName:
                  - Ref: RecieptsBucketName
                eventSource:
                - s3.amazonaws.com
                eventName:
                - PutObject
      DefinitionSubstitutions:
        ReceiptsReadeArn:
          Fn::GetAtt:
          - ReceiptReaderFunction
          - Arn
        PaymentsProcessorArn:
          Fn::GetAtt:
          - PaymentsProcessorFunction
          - Arn
        ErrorTopicArn:
          Ref: AppErrorSnsTopic
      Policies:
      - LambdaInvokePolicy:
          FunctionName:
            Ref: ReceiptReaderFunction
      - LambdaInvokePolicy:
          FunctionName:
            Ref: PaymentsProcessorFunction
      - SNSPublishMessagePolicy:
          TopicName:
            Fn::GetAtt:
            - AppErrorSnsTopic
            - TopicName
  ReceiptReaderFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: app-receipt-reader
      CodeUri: ReceiptReaderFunction
      Policies:
      - S3ReadPolicy:
          BucketName:
            Ref: RecieptsBucketName
  PaymentsProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: app-payments-processor
      CodeUri: PaymentsProcessorFunction
      Environment:
        Variables:
          QueueUrl:
            Ref: PaymentsQueue
      Policies:
      - SQSSendMessagePolicy:
          QueueName:
            Ref: PaymentsQueueName
  ReceiptsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName:
        Ref: RecieptsBucketName
  CloudTrailBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName:
        Ref: CloudTrailBucketName
  PaymentsQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName:
        Ref: PaymentsQueueName
      FifoQueue: true
      ContentBasedDeduplication: true
  AppErrorSnsTopic:
    Type: AWS::SNS::Topic
    Properties:
      FifoTopic: false
      Subscription:
      - Endpoint: samjerusalem@gmail.com
        Protocol: email-json
      TopicName: AppErrorNotifier
  S3EventCloudTrail:
    Type: AWS::CloudTrail::Trail
    DependsOn:
    - CloudTrailBucketPolicy
    Properties:
      TrailName: S3EventCloudTrail
      S3BucketName:
        Ref: CloudTrailBucketName
      IsLogging: true
      IsMultiRegionTrail: false
      EventSelectors:
      - IncludeManagementEvents: false
        DataResources:
        - Type: AWS::S3::Object
          Values:
          - Fn::Sub: arn:aws:s3:::${RecieptsBucketName}/
      IncludeGlobalServiceEvents: false
  CloudTrailBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket:
        Ref: CloudTrailBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Sid: AWSCloudTrailAclCheck
          Effect: Allow
          Principal:
            Service: cloudtrail.amazonaws.com
          Action: s3:GetBucketAcl
          Resource:
            Fn::Sub: arn:aws:s3:::${CloudTrailBucketName}
        - Sid: AWSCloudTrailWrite
          Effect: Allow
          Principal:
            Service: cloudtrail.amazonaws.com
          Action: s3:PutObject
          Resource:
            Fn::Sub: arn:aws:s3:::${CloudTrailBucketName}/AWSLogs/${AWS::AccountId}/*
          Condition:
            StringEquals:
              s3:x-amz-acl: bucket-owner-full-control
Outputs:
  ReceiptsBucket:
    Description: Created Receipts Bucket Arn
    Value:
      Fn::GetAtt:
      - ReceiptsBucket
      - Arn
  PaymentsQueue:
    Description: Payments Queue URL
    Value:
      Ref: PaymentsQueue
